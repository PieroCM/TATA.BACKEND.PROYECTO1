# ==========================================
# ?? TEST DEFINITIVO: Personalizado vs Resumen
# ==========================================

param(
    [string]$ApiUrl = "https://localhost:7152"
)

$ErrorActionPreference = "Continue"
[Net.ServicePointManager]::ServerCertificateValidationCallback = { $true }

Write-Host @"
????????????????????????????????????????????????????????????
?  ?? TEST: ¿Por qué Personalizado funciona pero          ?
?         Resumen NO?                                     ?
????????????????????????????????????????????????????????????
"@ -ForegroundColor Red

Write-Host "`nAPI: $ApiUrl" -ForegroundColor Gray
Write-Host ""

# ==========================================
# OPCIÓN 1: Test de Comparación Automático
# ==========================================
Write-Host "????????????????????????????????????????????????????????" -ForegroundColor Yellow
Write-Host "?? OPCIÓN 1: Test de Comparación Automático" -ForegroundColor Yellow
Write-Host "????????????????????????????????????????????????????????" -ForegroundColor Yellow

try {
    Write-Host "`nEjecutando: POST $ApiUrl/api/email/test-comparison" -ForegroundColor Gray
    Write-Host "Esto enviará 2 correos:" -ForegroundColor White
    Write-Host "  1. Personalizado (que funciona)" -ForegroundColor Green
    Write-Host "  2. Resumen diario (que falla)" -ForegroundColor Red
    Write-Host ""
    
    $response = Invoke-RestMethod -Uri "$ApiUrl/api/email/test-comparison" -Method POST -TimeoutSec 60
    
    Write-Host "??????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host "?  ?? RESULTADOS DEL TEST DE COMPARACIÓN                ?" -ForegroundColor Cyan
    Write-Host "??????????????????????????????????????????????????????????" -ForegroundColor Cyan
    
    # TEST 1: Personalizado
    Write-Host "`n?? TEST 1: Envío Personalizado" -ForegroundColor Yellow
    if ($response.test1_envioPersonalizado.exitoso) {
        Write-Host "   ? EXITOSO" -ForegroundColor Green
        Write-Host "   ??  Duración: $($response.test1_envioPersonalizado.duracionSegundos) segundos" -ForegroundColor Gray
        Write-Host "   ?? Destinatario: $($response.test1_envioPersonalizado.destinatario)" -ForegroundColor Gray
    } else {
        Write-Host "   ? FALLÓ" -ForegroundColor Red
        Write-Host "   Error: $($response.test1_envioPersonalizado.error)" -ForegroundColor Red
    }
    
    # TEST 2: Resumen
    Write-Host "`n?? TEST 2: Resumen Diario" -ForegroundColor Yellow
    if ($response.test2_resumenDiario.exitoso) {
        Write-Host "   ? EXITOSO" -ForegroundColor Green
        Write-Host "   ??  Duración: $($response.test2_resumenDiario.duracionSegundos) segundos" -ForegroundColor Gray
    } else {
        Write-Host "   ? FALLÓ" -ForegroundColor Red
        Write-Host "   Error: $($response.test2_resumenDiario.error)" -ForegroundColor Red
    }
    
    # Análisis
    Write-Host "`n??????????????????????????????????????????????????????????" -ForegroundColor Magenta
    Write-Host "?  ?? ANÁLISIS                                          ?" -ForegroundColor Magenta
    Write-Host "??????????????????????????????????????????????????????????" -ForegroundColor Magenta
    Write-Host "`n$($response.analisis)" -ForegroundColor White
    
    # Recomendaciones
    if ($response.test1_envioPersonalizado.exitoso -and $response.test2_resumenDiario.exitoso) {
        Write-Host "`n?? RECOMENDACIÓN:" -ForegroundColor Yellow
        Write-Host "   Ambos correos SE ENVIARON correctamente." -ForegroundColor White
        Write-Host "   Si el resumen NO llega a tu bandeja:" -ForegroundColor White
        Write-Host "   1. Revisa SPAM" -ForegroundColor Gray
        Write-Host "   2. Revisa Promociones/Notificaciones" -ForegroundColor Gray
        Write-Host "   3. Busca: [RESUMEN DIARIO SLA]" -ForegroundColor Gray
        Write-Host "   4. Gmail está bloqueando el contenido HTML del resumen" -ForegroundColor Gray
    }
    elseif ($response.test1_envioPersonalizado.exitoso -and -not $response.test2_resumenDiario.exitoso) {
        Write-Host "`n?? RECOMENDACIÓN:" -ForegroundColor Yellow
        Write-Host "   El problema está ESPECÍFICAMENTE en SendDailySummaryAsync()" -ForegroundColor Red
        Write-Host "   Revisa Visual Studio Output para ver logs detallados" -ForegroundColor White
        Write-Host "   El error real está en los logs con emojis ?? ? ?" -ForegroundColor Gray
    }
    
} catch {
    Write-Host "`n? ERROR al ejecutar test de comparación" -ForegroundColor Red
    Write-Host "   $($_.Exception.Message)" -ForegroundColor Gray
}

# ==========================================
# OPCIÓN 2: Test Manual del Resumen
# ==========================================
Write-Host "`n????????????????????????????????????????????????????????" -ForegroundColor Yellow
Write-Host "?? OPCIÓN 2: Test Manual del Resumen (con logs detallados)" -ForegroundColor Yellow
Write-Host "????????????????????????????????????????????????????????" -ForegroundColor Yellow

Write-Host "`n??  IMPORTANTE: Abre Visual Studio Output Window AHORA" -ForegroundColor Red
Write-Host "   1. View ? Output" -ForegroundColor White
Write-Host "   2. Show output from: Debug" -ForegroundColor White
Write-Host "   3. Busca líneas con: ?? ? ? ???" -ForegroundColor White
Write-Host ""

$respuesta = Read-Host "¿Tienes Output abierto? (SI/NO)"

if ($respuesta -eq "SI") {
    try {
        Write-Host "`n?? Enviando resumen diario..." -ForegroundColor Yellow
        Write-Host "   Observa el Output en Visual Studio" -ForegroundColor Gray
        Write-Host ""
        
        $response = Invoke-RestMethod -Uri "$ApiUrl/api/email/send-summary" -Method POST -TimeoutSec 60
        
        Write-Host "??????????????????????????????????????????????????????????" -ForegroundColor Green
        Write-Host "?  ? API RESPUESTA: ÉXITO                              ?" -ForegroundColor Green
        Write-Host "??????????????????????????????????????????????????????????" -ForegroundColor Green
        Write-Host "`nMensaje: $($response.mensaje)" -ForegroundColor White
        Write-Host "Duración: $($response.duracionSegundos) segundos" -ForegroundColor Gray
        
        Write-Host "`n?? AHORA REVISA EL OUTPUT EN VISUAL STUDIO" -ForegroundColor Yellow
        Write-Host "   Busca estas líneas en orden:" -ForegroundColor White
        Write-Host "   ?? [PASO 1/7] INICIANDO envío..." -ForegroundColor Gray
        Write-Host "   ?? [PASO 2/7] Consultando EmailConfig..." -ForegroundColor Gray
        Write-Host "   ?? [PASO 3/7] Consultando alertas..." -ForegroundColor Gray
        Write-Host "   ?? [PASO 4/7] Generando HTML..." -ForegroundColor Gray
        Write-Host "   ?? [PASO 5/7] Preparando envío..." -ForegroundColor Gray
        Write-Host "   ?? [PASO 6/7] LLAMANDO A EmailService..." -ForegroundColor Gray
        Write-Host "   ?? [PASO 7/7] Registrando en email_log..." -ForegroundColor Gray
        Write-Host ""
        Write-Host "   Si se detiene en algún paso, ese es el problema." -ForegroundColor Yellow
        
    } catch {
        $statusCode = $_.Exception.Response.StatusCode.value__
        
        Write-Host "`n??????????????????????????????????????????????????????????" -ForegroundColor Red
        Write-Host "?  ? API RESPUESTA: ERROR $statusCode                    ?" -ForegroundColor Red
        Write-Host "??????????????????????????????????????????????????????????" -ForegroundColor Red
        
        try {
            $errorStream = $_.Exception.Response.GetResponseStream()
            $reader = New-Object System.IO.StreamReader($errorStream)
            $errorResponse = $reader.ReadToEnd() | ConvertFrom-Json
            $reader.Close()
            
            Write-Host "`nError: $($errorResponse.error)" -ForegroundColor White
            
            if ($errorResponse.detalleCompleto) {
                Write-Host "`nDetalle (primeras 500 chars):" -ForegroundColor Gray
                $detalle = $errorResponse.detalleCompleto
                if ($detalle.Length -gt 500) {
                    $detalle = $detalle.Substring(0, 500) + "..."
                }
                Write-Host $detalle -ForegroundColor DarkGray
            }
        } catch {
            Write-Host "   $($_.Exception.Message)" -ForegroundColor Gray
        }
        
        Write-Host "`n?? REVISA LOS LOGS EN VISUAL STUDIO OUTPUT" -ForegroundColor Yellow
        Write-Host "   El error real está ahí con más detalle" -ForegroundColor White
    }
} else {
    Write-Host "`n??  Por favor abre Visual Studio Output primero" -ForegroundColor Yellow
    Write-Host "   Los logs detallados están ahí" -ForegroundColor Gray
}

# ==========================================
# INSTRUCCIONES FINALES
# ==========================================
Write-Host "`n????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?  ?? QUÉ BUSCAR EN LOS LOGS                              ?" -ForegroundColor Cyan
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor Cyan

Write-Host @"

Los logs ahora tienen símbolos para identificar rápido:

  ?? = Iniciando operación
  ? = Operación exitosa
  ? = Error crítico
  ??  = Advertencia
  ?? ?? ?? ?? ?? ?? = Pasos del proceso
  ??? = Separadores de secciones

Si el proceso se detiene después de:

  ?? [PASO 6/7] LLAMANDO A EmailService.SendAsync...
  
Y NO ves:
  
  ??? [ÉXITO] EmailService.SendAsync completado

? El problema está EN EmailService.SendAsync
? Revisa el log siguiente para ver el error SMTP específico

Si ves:

  ??? [COMPLETADO] Resumen diario enviado exitosamente
  
Pero el correo NO llega:

? El correo SÍ se envió correctamente
? Gmail lo está bloqueando o enviando a SPAM
? Revisa tu carpeta de SPAM

"@ -ForegroundColor White

Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host "?  ? TEST COMPLETADO                                     ?" -ForegroundColor Green
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host ""
